# Setup: Create a git repo inside the test sandbox
exec git init
exec git config user.email test@example.com
exec git config user.name test

# Create a registry config
mkdir registry
cp config.yml registry/json-schema-manager-config.yml

# Create initial schema
mkdir registry/domain/family/1/0/0
cp schema.json registry/domain/family/1/0/0/domain_family_1_0_0.schema.json
exec git add .
exec git commit -m "first"
exec git tag jsm-deploy/production/v1

# Run our check-changes command (should be empty/clean)
env JSM_REGISTRY_ROOT_DIR=registry
exec jsm check-changes production
stdout 'All changes are valid'

# Modify the schema and check again (should fail on mutation)
cp modified.schema.json registry/domain/family/1/0/0/domain_family_1_0_0.schema.json
exec git add .
exec git commit -m "mutation"

! exec jsm check-changes production
stderr 'cannot modify deployed schemas'

-- config.yml --
environments:
  production:
    privateUrlRoot: "https://json-schemas.internal.myorg.io/"
    publicUrlRoot: "https://json-schemas.myorg.io/"
    isProduction: true
    allowSchemaMutation: false
-- schema.json --
{}
-- modified.schema.json --
{"type": "object"}
